@model Trip
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = @Html.DisplayFor(model => model.Name);
    var requestToken = Antiforgery.GetAndStoreTokens(Context).RequestToken;

    int userId = int.TryParse(User.FindFirstValue("CustomUserId"), out int tempUserId) ? tempUserId : -1;
    bool isCreator = (userId == Model.CreatorId) ? true : false;

    //string searchString = ViewBag.SearchString;
    Random rnd = new Random();
    int randRotate = rnd.Next(1, 5);
}

@*PEOPLE + EXPENSES*@
<form asp-action="Edit">
<div class="row mb-1">
    <div class="col" style="min-width: 375px; max-width:450px;">

        <div class="card shadow bg-light border-0 rounded-0 p-2 mb-3 rotated-@randRotate" style="min-height: 300px;">
            @*--PHOTO-FRAME--*@
            <div class="img-frame border border-secondary position-relative">
                @if (Model.ImagePath != null)
                {
                    <!-- Mobile view (width: 100%, fixed height) -->
                    <img src="@Url.Content(Model.ImagePath)" alt="image" class="card-img-top rounded-0 img-fluid d-lg-none" style="min-height: 220px; max-height: 325px; object-fit: cover;">

                    <!-- Desktop view (fixed width, height: 100%) -->
                    <img src="@Url.Content(Model.ImagePath)" alt="image" class="card-img-top rounded-0 img-fluid d-none d-lg-block" style="min-height: 400px; max-height: 450px; object-fit: cover;">
                }
                else
                {
                    <!-- Mobile view (width: 100%, fixed height) -->
                    <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80"
                         class="card-img-top rounded-0 img-fluid d-lg-none" style="min-height: 220px; max-height: 325px; object-fit: cover;">

                    <!-- Desktop view (fixed width, height: 100%) -->
                    <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80"
                         class="card-img-top rounded-0 img-fluid d-none d-lg-block" style="min-height: 400px; max-height: 450px; object-fit: cover;">
                }
                @*--PHOTO - INFO--*@
                <div id="tripEdit" class="position-absolute bottom-0 end-0 p-3 text-white">

                    <h1 class="display-4 align-end text-white polaroid">@Html.DisplayFor(modelItem => Model.Name)</h1>
                    <small class="text-white polaroid">@Html.DisplayFor(model => model.DateFrom) -  @Html.DisplayFor(model => model.DateTo)</small>

                </div>
            </div>


            @*--TRIP CONTROLS--*@
            @if (isCreator)
            {
                @*--ADD PARTICIPANT--*@
                <div class="input-group input-group-sm">
                    <input type="text" name="searchString" id="searchString" class="form-control border-info rounded-top-0 border-top-0 bg-secondary" placeholder="search users" required
                           hx-get="@Url.Action("SearchParticipant", "TripParticipants", new { tripId = Model.Id})"
                           hx-target="#searchParticipant"
                           hx-trigger="keyup changed delay:300ms" />

                    <button class="btn btn-sm btn-outline-info border-info rounded-top-0 border-top-0"
                            hx-post="@Url.Action("AddDummy", "Trips", new { id = Model.Id})"
                            hx-target="#tripParticipants"
                            hx-select="#tripParticipants"
                            hx-include="#searchString">
                        Add Dummy
                    </button>

                    @*--EDIT + DELETE--*@
                    <button class="btn btn-sm btn-outline-secondary border-top-0 rounded-top-0"
                            hx-get=@Url.Action("Edit", "Trips", new { id = Model.Id })
                            hx-target="#tripEdit">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger border-top-0 rounded-top-0"
                            hx-delete=@Url.Action("Delete", "Trips", new { id = Model.Id })
                            hx-target="body"
                            hx-push-url="true"
                            hx-confirm="Are you sure you want to delete this item?">
                        Delete
                    </button>
                    @* DELETE FORM - SO TRIP INDEX IS NORMALLY RENDERED*@
                    @*<form method="post" action="/Trips/Delete/@Model.Id">
                <button type="submit" class="btn btn-sm btn-outline-danger border-top-0 rounded-top-0"
                onclick="return confirm('Are you sure you want to delete this item?');">
                Delete
                </button>
                </form>*@
                </div>
            }

            <div id="searchParticipant">
                @*DIV FOR SEARCH RESULTS*@
            </div>

            @*EACH PARTICIPANT*@
            <div id="tripParticipants">
            <div class="container-fluid mt-2">
                <div class="row no-gutters">
                    @foreach (var participant in Model.Participants)
                    {
                        double? paymSum = participant.Payments.Sum(p => p.Ammount);
                        string cardBg = participant.UserId == null ? "bg-white border-info" : "bg-white";

                            <div class="col-auto p-0">

                            <div class="card shadow m-1 polaroid @cardBg" style="min-width: 5rem;">


                                @*<div class="card-body" ondblclick="return alert('You cant delete participant that has payments!');">*@
                                <div class="card-body p-1"
                                     hx-delete=@Url.Action("DeleteParticipant", "Trips", new {id = Model.Id, participantId = participant.Id })
                                     hx-trigger="dblclick[isCreator()]"
                                     hx-target="body"
                                     hx-confirm="@(participant.Payments.Count(p => p.IsValid) == 0 ? "Are you sure you want to delete Participant?" : "You cant delete participant that has payments")">

                                    <h5 class="card-text text-black">
                                        @(participant.UserName)
                                        @if (paymSum.HasValue)
                                        {


                                            @if (paymSum >= 0)
                                            {
                                                <span class="text-success"><b>@paymSum.Value.ToString("C2")</b></span>
                                            }
                                            else
                                            {
                                                <span class="text-danger"><b>@paymSum.Value.ToString("C2")</b></span>
                                            }
                                        }
                                    </h5>
                                    @*<small class="text-white-50">
                                Payments:*@
                                    @*<span class="badge rounded-pill bg-secondary position-absolute top-0 end-0">@part.Value.paymCount</span>*@
                                    @**</small>*@
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            </div>
        </div>
    </div>


    @*COL OF EXPENSES*@
    <div class="col" style="min-width: 330px; min-height: 750px; max-height: 750px;overflow-y: auto;">
        <section>
            <partial name="~/Views/Expenses/_Index.cshtml" model="Model.Expenses" />
        </section>
    </div>
</div>
</form>


<script>
    function isCreator() {
        return @Html.Raw(Json.Serialize(isCreator));
    }
</script>


